# Nginx Configuration for Streaming SSE Endpoints
# Place this in: /etc/nginx/sites-available/chatbot-backend
# Then symlink to: /etc/nginx/sites-enabled/

# Upstream Node.js application
upstream chatbot_backend {
    # Use least_conn for better load distribution with streaming
    least_conn;

    # Multiple Node.js instances (PM2 cluster mode)
    server 127.0.0.1:5000 max_fails=3 fail_timeout=30s;
    # server 127.0.0.1:5001 max_fails=3 fail_timeout=30s;
    # server 127.0.0.1:5002 max_fails=3 fail_timeout=30s;

    # Keep connections alive
    keepalive 64;
}

server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # Redirect HTTP to HTTPS (recommended for production)
    # return 301 https://$server_name$request_uri;

    # Or serve directly (if not using HTTPS)
    # Uncomment the location blocks below if serving over HTTP
}

server {
    # listen 443 ssl http2;
    listen 80;  # Use this for HTTP, or 443 for HTTPS
    server_name your-domain.com www.your-domain.com;

    # SSL Configuration (if using HTTPS)
    # ssl_certificate /path/to/fullchain.pem;
    # ssl_certificate_key /path/to/privkey.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;

    # General Settings
    client_max_body_size 50M;
    client_body_timeout 300s;
    client_header_timeout 300s;

    # Logging
    access_log /var/log/nginx/chatbot-backend-access.log;
    error_log /var/log/nginx/chatbot-backend-error.log warn;

    # ========================================================================
    # STREAMING ENDPOINTS - SPECIAL CONFIGURATION
    # ========================================================================
    # Critical: SSE requires buffering to be disabled

    # User Chatbot Streaming
    location /api/chat/query/stream {
        proxy_pass http://chatbot_backend;

        # SSE CRITICAL: Disable all buffering
        proxy_buffering off;
        proxy_cache off;

        # SSE CRITICAL: Set headers for SSE
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding on;

        # Forward client information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE CRITICAL: Increase timeouts for long-lived connections
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        send_timeout 300s;

        # Keep connection alive
        proxy_set_header Connection "keep-alive";
    }

    # Troika Intelligent Chat Streaming
    location /api/troika/intelligent-chat/stream {
        proxy_pass http://chatbot_backend;

        # SSE CRITICAL: Disable all buffering
        proxy_buffering off;
        proxy_cache off;

        # SSE CRITICAL: Set headers for SSE
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding on;

        # Forward client information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE CRITICAL: Increase timeouts for long-lived connections
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        send_timeout 300s;

        # Keep connection alive
        proxy_set_header Connection "keep-alive";
    }

    # ========================================================================
    # REGULAR API ENDPOINTS
    # ========================================================================
    # Standard configuration for non-streaming endpoints

    location /api/ {
        proxy_pass http://chatbot_backend;

        # Standard proxy settings
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Standard timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ========================================================================
    # HEALTH CHECK & METRICS
    # ========================================================================

    # Health check endpoint
    location /api/metrics/health/streaming {
        proxy_pass http://chatbot_backend;

        # Quick health checks
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;

        # Allow from specific monitoring IPs only (optional)
        # allow 10.0.0.0/8;
        # deny all;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Metrics endpoint (protect with authentication in production)
    location /api/metrics/ {
        proxy_pass http://chatbot_backend;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Optional: Restrict access to internal network
        # allow 10.0.0.0/8;
        # allow 192.168.0.0/16;
        # deny all;
    }

    # ========================================================================
    # STATIC FILES (if any)
    # ========================================================================

    location /public/ {
        alias /path/to/chatbot-backend/public/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Root endpoint
    location / {
        proxy_pass http://chatbot_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ============================================================================
# ADDITIONAL NGINX TUNING FOR STREAMING
# ============================================================================
# Add these to /etc/nginx/nginx.conf in the http block

# http {
#     # Increase worker connections for concurrent streams
#     events {
#         worker_connections 4096;
#         use epoll;
#         multi_accept on;
#     }
#
#     # Keep-alive settings
#     keepalive_timeout 65;
#     keepalive_requests 100;
#
#     # Buffer sizes (important for SSE)
#     client_body_buffer_size 128k;
#     client_header_buffer_size 1k;
#     large_client_header_buffers 4 16k;
#
#     # Gzip (disable for SSE endpoints)
#     gzip on;
#     gzip_vary on;
#     gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
#     gzip_disable "msie6";
# }

# ============================================================================
# TESTING THE CONFIGURATION
# ============================================================================
# 1. Test Nginx config:
#    sudo nginx -t
#
# 2. Reload Nginx:
#    sudo systemctl reload nginx
#
# 3. Test SSE streaming:
#    curl -N http://your-domain.com/api/chat/query/stream \
#      -H "Content-Type: application/json" \
#      -d '{"query":"Hello","chatbotId":"your-id","sessionId":"test-uuid","enableTTS":false}'
#
# 4. Monitor Nginx error logs:
#    sudo tail -f /var/log/nginx/chatbot-backend-error.log
#
# 5. Check connection stats:
#    sudo netstat -an | grep :80 | wc -l
